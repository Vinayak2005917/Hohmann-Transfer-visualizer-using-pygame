<html lang="en-us"><script src="https://pygame-web.github.io/archives/0.9/pythons.js" type=module id=site data-LINES=57 data-CONSOLE=25 data-python=python3.12 data-os=vtx,fs,snd,gui async defer><!--

print("""
Loading hohmann_test from hohmann_test.apk
    Pygbag Version : 0.9.2
    Template Version : 0.9.0
    Python  : 3.12
    CDN URL : https://pygame-web.github.io/archives/0.9/
    Screen  : 1280x720
    Title   : hohmann_test
    Folder  : hohmann_test
    Authors : pgw
    SPDX-License-Identifier: cookiecutter.spdx

""")


# screen pixels (real, hardware)
WIDTH=1024  # 1280
HEIGHT=600  # 720

# reference/idealized screen pixels
REFX = 1980
REFY = 1080

def u(real, ref, v):
    if abs(v)<0.9999999:
        result = int( (float(real)/100.0) * (v*1000))
        if v<0:
            return real-result
        return result
    return int( (real/ref) * v )

def ux(*argv):
    global WIDTH, REFX
    acc = 0
    for v in argv:
        acc += u(WIDTH, REFX, v)
    return acc

def uy(*argv):
    global HEIGHT, REFY
    acc = 0
    for v in argv:
        acc += u(HEIGHT, REFY, v)
    return acc




# do not rename
async def custom_site():

    import sys
    import asyncio
    import platform
    import json
    from pathlib import Path



    import embed


    platform.document.body.style.background = "#7f7f7f"

    import pygame

    def compose():
        pygame.display.update()
        window.chromakey(None, *screen.get_colorkey(), 40)

    pygame.init()
    pygame.font.init()

    screen = pygame.display.set_mode([ux(.100),uy(.100)], pygame.SRCALPHA, 32)
    screen.set_colorkey( (0,0,0,0), pygame.RLEACCEL )
    screen.fill( (0,0,0,0) )

    compose()

    platform.window.transfer.hidden = true
    platform.window.canvas.style.visibility = "visible"



    apk = "hohmann_test.apk"

    bundle = "hohmann_test"

    # the C or js loader could do that but be explicit.
    appdir = Path(f"/data/data/{bundle}") # /data/data/hohmann_test
    appdir.mkdir()


    # mount apk

    cfg = {
        "io": "url",
        "type":"mount",
        "mount" : {
            "point" : appdir.as_posix(),
            "path" : "/",
        },
        "path" : f"/ => {appdir.as_posix()}",
    }


    track = platform.window.MM.prepare(apk, json.dumps(cfg))

    marginx = ux(.020) # 20%
    marginy = uy(.045) # 45%


    def pg_bar(pos):
        nonlocal marginx, marginy
        # resolution of progress bar, recalculate since it may not be know yet.
        total = track.len or 10  # avoid div0
        slot = ux(.060)/ total # 60%

        pygame.draw.rect(screen,(10,10,10),( marginx-ux(10), marginy-uy(10), (total*slot)+ux(20), uy(110) ) )
        pygame.draw.rect(screen,(0,255,0), ( marginx, marginy, track.pos*slot, uy(90)) )

    # wait until zip mount + overlayfs is complete
    while not track.ready:
        pg_bar(track.pos)
        compose()
        await asyncio.sleep(.1)

    # fill it up in case it was cached and instant download
    pg_bar(track.len)
    compose()


    # preloader will change dir and prepend it to sys.path
    platform.run_main(PyConfig, loaderhome= appdir / "assets", loadermain=None)


    # wait preloading complete
    # that includes images and wasm compilation of bundled modules
    while embed.counter()<0:
        await asyncio.sleep(.1)

    main = appdir / "assets" / "main.py"

    # start async top level machinery and add a console.
    await TopLevel_async_handler.start_toplevel(platform.shell, console=window.python.config.debug)

    # now that apk is mounted we have access to font cache
    # but we need to fill __file__ that is not yet set
    __import__(__name__).__file__ = str(main)


    # now make a prompt
    fnt = pygame.sysfont.SysFont("freesans",  uy(80) )

    def ui_callback(pkg, error=None):
        nonlocal fnt
        if error:
            prompt = fnt.render(f"{error}", True, "black")
        else:
            prompt = fnt.render(f"Setting [{pkg}] up", True, "black")
        pg_bar(track.len)
        screen.blit(prompt, ( marginx+ ux(80), marginy - uy(10) ) )
        compose()

    # test/wait if user media interaction required
    if not platform.window.MM.UME:
        # now make a prompt
        fnt = pygame.sysfont.SysFont("freesans",  uy(80) )
        prompt = fnt.render("Click/tap to start!", True, "blue")
        pg_bar(track.len)
        screen.blit(prompt, ( marginx+ ux(80), marginy - uy(10) ) )
        compose()
        print("* Waiting for user interaction: please click/touch page *")
        while not platform.window.MM.UME:
            await asyncio.sleep(.1)

    # cleanup
    screen.fill( (0,0,0,0) )
    pygame.display.flip()

    await shell.runpy(main, callback=ui_callback)



import asyncio

asyncio.run( custom_site() )












--></script><head>
<script type="application/javascript">
// Asset loading with fallback and retry logic
window.loadingState = {
    assetsLoaded: 0,
    totalAssets: 0,
    failed: false,
    retryCount: 0,
    maxRetries: 3
};

// Fallback reload function
function reloadWithFallback() {
    window.loadingState.retryCount++;
    if (window.loadingState.retryCount <= window.loadingState.maxRetries) {
        console.log(`Loading failed, retry ${window.loadingState.retryCount}/${window.loadingState.maxRetries}`);
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    } else {
        console.error('Maximum retries exceeded. Please check your connection and try again.');
        document.getElementById('status').innerText = 'Loading failed. Please refresh the page.';
    }
}

// Monitor WebAssembly and asset loading
window.addEventListener('error', function(e) {
    console.error('Loading error:', e);
    if (e.message && (e.message.includes('wasm') || e.message.includes('fetch'))) {
        window.loadingState.failed = true;
        reloadWithFallback();
    }
});

// WebAssembly detection and fallback
if (!window.WebAssembly) {
    document.getElementById('status').innerText = 'WebAssembly not supported in this browser.';
} else {
    // Test WebAssembly support
    try {
        new WebAssembly.Module(new Uint8Array([0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00]));
    } catch (e) {
        console.error('WebAssembly test failed:', e);
        reloadWithFallback();
    }
}

config = {
    xtermjs : "1" ,
    _sdl2 : "canvas",
    user_canvas : 0,
    user_canvas_managed : 0,
    ume_block : 1,
    can_close : 0,
    archive : "hohmann_test",
    gui_debug : 3,
    cdn : "https://pygame-web.github.io/archives/0.9/",
    autorun : 0,
    PYBUILD : "3.12"
}
</script>

    <title>hohmann_test</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="height=device-height, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes"/>

    <!-- Preload critical assets for faster loading -->
    <link rel="preload" href="hohmann_test.apk" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://pygame-web.github.io/archives/0.9/pythons.js" as="script">
    <link rel="preload" href="https://pygame-web.github.io/archives/0.9/browserfs.min.js" as="script">
    <link rel="preload" href="https://pygame-web.github.io/archives/0.9/pythonrc.py" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://pygame-web.github.io/archives/0.9/vt/xterm.js" as="script">
    <link rel="preload" href="https://pygame-web.github.io/archives/0.9/vt/xterm-addon-image.js" as="script">
    
    <!-- Prefetch additional resources -->
    <link rel="prefetch" href="https://pygame-web.github.io/archives/0.9/empty.html">

    <link rel="icon" type="image/png" href="favicon.png" sizes="16x16">

    <style>
        #status {
            display: inline-block;
            vertical-align: top;
            margin-top: 20px;
            margin-left: 30px;
            font-weight: bold;
            color: rgb(120, 120, 120);
            font-size: 14px;
        }

        #progress {
            height: 20px;
            width: 300px;
            border-radius: 10px;
            overflow: hidden;
        }

        div.emscripten { 
            text-align: center; 
            padding: 10px;
        }
        div.emscripten_border { border: 1px solid black; }
        div.thick_border { border: 4px solid black; }

        /* Canvas styling for better performance */
        canvas.emscripten {
            border: 0px none;
            background-color: transparent;
            width: 100%;
            height: 100%;
            z-index: 5;
            padding: 0;
            margin: 0 auto;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: powderblue;
            overflow: hidden;
        }

        /* Loading overlay */
        #transfer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(176, 224, 230, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .topright{
           position:absolute;
           top:0px;
           right:0px;
        }

        .bottomright {
            position:absolute;
            top: 40%;
            right: 0px;
        }

        .center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trinfo{
           position:relative;
           right:0px;
           border: 1px solid black;
        }

        .framed{
           position:relative;
           top:150px;
           right:10px;
           border: 1px solid black;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #progress {
                width: 250px;
            }
            #status {
                font-size: 12px;
                margin-left: 10px;
            }
        }

        /* Loading animation */
        .loading-dots {
            display: inline-block;
        }
        .loading-dots:after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>

    <script src="https://pygame-web.github.io/archives/0.9//browserfs.min.js"></script>

</head>

<body>

    <div id="transfer" align=center>
        <div class="emscripten" id="status">Loading<span class="loading-dots"></span></div>
        <div class="emscripten">
            <progress value="0" max="100" id="progress"></progress>
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            <span id="loading-info">This might take a while. Preparing assets...</span>
        </div>
    </div>


    <canvas class="emscripten" id="canvas"
width="1px"
height="1px"
    oncontextmenu="event.preventDefault()" tabindex=1>
    </canvas>

    <div id=html></div>

    <div id=crt  class=bottomright >

        <div id="system" hidden>
            <div class="button-container">
                <button id="aiostop" disabled>AIO ⏏︎</button>
                <button id="aiopaused_true" disabled>AIO ■</button>
                <button id="aiopaused_false" disabled>AIO ▶</button>
                <button id="pygame_mixer_music_pause" disabled>Music ■</button>
            </div>

            <div class="button-container">
                <div id=load_min>min</div>
                <div id=load_avg>avg</div>
                <div id=load_max>max</div>
              <button id="load_rst" disabled>RESET</button>
            </div>

            <div id="level">(battery level unknown)</div>
            <div id="stateBattery">(charging state unknown)</div>

        </div>

        <div id=box class="emscripten_border" hidden=true>

            <div id="info" class="trinfo"></div>

            <iframe id="iframe" class="framed" name="iframe"
width="470px" height="90%"
allowtransparency="true"
style="z-index: 10;"
style="background: #FFFFFF;"
frameborder="1"
                allowfullscreen="true"
                webkitallowfullscreen="true"
                msallowfullscreen="true"
                mozallowfullscreen="true"
                sandbox="allow-same-origin allow-top-navigation allow-scripts allow-pointer-lock"
                allow="autoplay; fullscreen *; geolocation; microphone; camera; midi; monetization; xr-spatial-tracking; gamepad; gyroscope; accelerometer; xr; cross-origin-isolated"
                src="https://pygame-web.github.io/archives/0.9/empty.html"
                scrolling="yes">
            </iframe>
        </div>

    </div>


    <div id="dlg" hidden>
        <input type="file" id="dlg_multifile" multiple accept="image/*">
        <label for="dlg_multifile">Select files</label>
    </div>

    <div id="pyconsole">
        <div id="terminal" tabIndex=1 align="left"></div>
    </div>

    <script type="application/javascript">

    async function custom_onload(debug_hidden) {
        console.log("custom_onload starting");
        
        // Enhanced loading state management
        try {
            pyconsole.hidden = debug_hidden
            system.hidden = debug_hidden
            transfer.hidden = debug_hidden
            info.hidden = debug_hidden
            box.hidden = debug_hidden
            
            // Ensure user interaction is properly handled
            if (!window.loadingState.failed) {
                console.log("Assets loaded successfully");
            }
        } catch (error) {
            console.error("Error in custom_onload:", error);
            window.loadingState.failed = true;
            reloadWithFallback();
        }
    }

    function custom_prerun(){
        console.log("custom_prerun starting");
        
        // Additional WebAssembly checks
        try {
            if (!WebAssembly.instantiate) {
                throw new Error("WebAssembly.instantiate not available");
            }
        } catch (error) {
            console.error("WebAssembly check failed:", error);
            window.loadingState.failed = true;
            reloadWithFallback();
        }
    }

    function custom_postrun(){
        console.log("custom_postrun starting");
        
        try {
            // Prevent arrow key scrolling for better game experience
            window.addEventListener("keydown", function(e) {
                if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
                    if (!python.config.debug)
                        e.preventDefault();
                }
            }, false);
            
            // Enhanced user interaction detection
            const interactionEvents = ['click', 'touchstart', 'keydown'];
            interactionEvents.forEach(eventType => {
                document.addEventListener(eventType, function() {
                    if (window.MM && !window.MM.UME) {
                        window.MM.UME = true;
                    }
                }, { once: true });
            });
            
        } catch (error) {
            console.error("Error in custom_postrun:", error);
        }
    }

    function debug() {
        python.config.debug = true
        custom_onload(false)
        Module.PyRun_SimpleString("shell.uptime()")
        window_resize()
    }

    function info_inline(data){
        document.getElementById("info").innerHTML = data
    }

    function info_online(url) {
        fetch(url)
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then((html) => {
                info_inline(html);
            })
            .catch((error) => {
                console.warn("Failed to load info:", error);
            });
    }

    function frame_online(url) {
        try {
            window.frames["iframe"].location = url;
        } catch (error) {
            console.warn("Failed to load frame:", error);
        }
    }

    // Enhanced asset loading monitoring
    window.addEventListener('beforeunload', function() {
        if (window.loadingState.failed && window.loadingState.retryCount < window.loadingState.maxRetries) {
            // Let the reload happen
            return;
        }
    });

    // Service Worker registration for better caching (optional)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // Only register if we have a service worker file
            // navigator.serviceWorker.register('/sw.js').catch(function(error) {
            //     console.log('ServiceWorker registration failed: ', error);
            // });
        });
    }

    // Enhanced progress monitoring
    let progressElement = document.getElementById('progress');
    let statusElement = document.getElementById('status');
    let loadingInfoElement = document.getElementById('loading-info');
    
    // Monitor loading progress
    window.setLoadingProgress = function(percent, message) {
        if (progressElement) {
            progressElement.value = percent;
        }
        if (loadingInfoElement && message) {
            loadingInfoElement.textContent = message;
        }
    };

    // Update status messages
    window.setLoadingStatus = function(status) {
        if (statusElement) {
            statusElement.innerHTML = status + '<span class="loading-dots"></span>';
        }
    };

    // Connection quality detection
    if ('connection' in navigator) {
        const connection = navigator.connection;
        if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
            setLoadingStatus('Loading (slow connection detected)');
        }
    }

    </script>

</body>
</html>
